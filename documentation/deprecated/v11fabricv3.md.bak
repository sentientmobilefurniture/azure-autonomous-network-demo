# V11 UI Revamp â€” Final Integrated Plan

> **Created:** 2026-02-16
> **Updated:** 2026-02-16 (integrated audit recommendations from v11ui1.md + v11ui2.md)
> **Status:** â¬œ Not started
> **Depends on:** V11 Fabric Integration (Phases 0â€“3, all implemented)
> **Scope:** Frontend restructure + 1 small backend endpoint + 3 bug fixes.
> **Goal:** Kill the monolithic SettingsModal. Replace with a clean chip-centric
> scenario flow, a connections slide-over for service health + Fabric setup, and a
> smooth non-blocking startup with ambient status awareness.

---

## The Problems

### Problem 1: The âš™ gear is a junk drawer

The `âš™` button opens an 860-line SettingsModal with 4 tabs (Scenarios, Data Sources,
Upload, Fabric Setup). It doesn't communicate what it contains, and the tabs mix
unrelated concerns: scenario lifecycle, data bindings, file uploads, and infrastructure
provisioning. Users have to hunt through tabs to find what they need.

### Problem 2: Fabric Setup tab is invisible until you already have a Fabric scenario

```
isFabricScenario = activeScenarioRecord?.graph_connector === 'fabric-gql'
```

Circular dependency: you need Fabric resources to create a Fabric scenario, but you
need a Fabric scenario to see the Fabric Setup tab where you'd provision those resources.

### Problem 3: No visibility into connected services

Users have no way to see what services are connected â€” CosmosDB, AI Search, Foundry,
Fabric, etc. The only health indicator is a small green dot labeled "API" that checks
a single `/health` endpoint. When something is misconfigured, there's no diagnostics.

### Problem 4: The startup loading overlay is hostile

When the app loads with a persisted scenario, a full-screen `bg-black/60 backdrop-blur-sm`
overlay blocks the entire UI with "Validating scenario..." â€” for up to 5 seconds. The user
can't do anything. If the API is slow, they stare at a spinner on a dark screen.

### Problem 5: No explicit backend selector (Fabric vs Cosmos)

Backend choice is buried in the tarball's `scenario.yaml` â€” no UI affordance.

### Problem 6: Three bugs in the Fabric discovery hook

| # | Bug | Location | Impact |
|---|-----|----------|--------|
| B1 | Health check response mismatch: backend returns `{"configured": bool}` but frontend checks `data.status === 'ok'` | `useFabricDiscovery.ts:69` vs `router_fabric_discovery.py:216` | Fabric always shows "unhealthy" |
| B2 | Provision endpoint mismatch: hook calls `/api/fabric/provision/pipeline` but route is `/api/fabric/provision` | `useFabricDiscovery.ts:136` vs `fabric_provision.py:386` | Provision always 404s |
| B3 | Stale closure: `provisionState` in both body and dep array | `useFabricDiscovery.ts:130-163` | Completion detection unreliable |
---

## Design

### Overview: What replaces what

```
BEFORE                                AFTER
â”€â”€â”€â”€â”€â”€                                â”€â”€â”€â”€â”€
Header:                               Header:
  â—† Title  [ScenarioChip â–¾]  â€¢API âš™    â—† Title  [ScenarioChip â–¾]  â€¢5/5  â€¢5Ag  ğŸ”Œ

âš™ â†’ SettingsModal (860 lines)         ScenarioChip dropdown:
  â”œâ”€ Scenarios tab                       â”œâ”€ Scenario quick-select (existing)
  â”œâ”€ Data Sources tab                    â”œâ”€ + New Scenario (existing)
  â”œâ”€ Upload tab                          â”œâ”€ âœ¦ Custom mode (existing)
  â””â”€ Fabric Setup tab                    â”œâ”€ âŠ Manage scenariosâ€¦ â†’ ScenarioManagerModal
                                         â””â”€ (AddScenarioModal unchanged)

                                       ğŸ”Œ â†’ ConnectionsDrawer (slide-over)
                                         â”œâ”€ Service health grid (grouped by role)
                                         â”œâ”€ Expandable rows with details
                                         â””â”€ Fabric actions (provision, browse)

Loading overlay (blocks UI)            Non-blocking startup:
  "Validating scenario..."               â”œâ”€ Start with persisted scenario (from localStorage)
                                         â”œâ”€ Skeleton chip while validating
                                         â”œâ”€ Background validation â†’ clear if deleted
                                         â””â”€ Crossfade transition on restore
```

### Change 1: Kill the âš™ gear â€” extend the ScenarioChip dropdown

The âš™ gear is removed. The header gains **one** icon: a connections button (ğŸ”Œ)
replacing the gear. The `âŠ Manage` action moves **into** the ScenarioChip dropdown
as a bottom menu item â€” no new header button needed.

**Header layout (after):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â—† AI Incident Investigator   [telecom-v3 Â· Cosmos â–¾]   â€¢5/5  â€¢5Ag  ğŸ”Œâ”‚
â”‚                               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€  â”€â”€â”€â”€  â”€â”€â”‚
â”‚                               ScenarioChip w/ badge     Svc   Agen  Cnâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**4 interactive elements** (same count as before):
1. App title (non-interactive)
2. ScenarioChip dropdown (scenario select + manage + new)
3. Ambient health summary (clickable â†’ opens ConnectionsDrawer)
4. Connections button ğŸ”Œ (opens ConnectionsDrawer)

**ScenarioChip dropdown (extended):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â— telecom-v3        Cosmos   42v    â”‚  â† active (brand highlight)
â”‚  â—‹ fabric-demo       Fabric   18v    â”‚  â† cyan badge
â”‚  â—‹ edge-test         Cosmos   12v    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  âœ¦ Custom mode                       â”‚
â”‚  + New Scenario                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  âŠ Manage scenariosâ€¦                 â”‚  â† opens ScenarioManagerModal
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why one entry point, not two:**
- The chip already has outside-click handling, animation, and keyboard state
- "Manage scenarios" is a natural extension of a scenario list â€” same mental model
- Zero new header chrome; the header stays clean at 48px height
- Users who open the dropdown to pick a scenario naturally discover "Manage" too

**Connections button (replaces âš™):**
- Icon: plug (ğŸ”Œ) or `<Cable />` from Lucide â€” recognizable, not abstract
- Colored status dot overlay on the icon: green (all ok), amber (warning), red (error)
- Opens the ConnectionsDrawer (slide-over, not modal)

### Change 2: Ambient service health in the header

Replace the single `<HealthDot label="API" />` with a clickable aggregate summary.

```
Current:   â€¢API
After:     â€¢5/5 Services
```

- Polls `GET /api/services/health` every 30s (same as current HealthDot polls `/health`)
- `N/M Services` where N = healthy, M = total configured
- Green when N === M, amber when N < M, red when critical services down
- Clicking opens the ConnectionsDrawer (same target as the ğŸ”Œ button)
- When all healthy: unobtrusive green. When degraded: the color change + count
  difference draws attention without an alert/popup

This makes service status **ambient** â€” problems surface automatically instead of
requiring the user to manually open a panel to check.

### Change 3: ScenarioManagerModal â€” simplified, inline data sources

A focused modal for scenario management. Not 3 tabs â€” instead, a **flat scenario
list with expandable detail rows**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MANAGE SCENARIOS                                     âœ•   â”‚
â”‚                                                          â”‚
â”‚ â”Œâ”€ Scenarios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                          â”‚
â”‚ [Scenarios tab]                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â— telecom-v3           Cosmos  â”‚ 42v  12p â”‚ â‹®   â”‚   â”‚
â”‚  â”‚   â–¸ Show details                                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â—‹ fabric-demo          Fabric  â”‚ 18v   8p â”‚ â‹®   â”‚âŒ„  â”‚
â”‚  â”‚   Graph: fabric-demo-topology                    â”‚   â”‚
â”‚  â”‚   Runbooks: fabric-demo-runbooks-index           â”‚   â”‚
â”‚  â”‚   Tickets: fabric-demo-tickets-index             â”‚   â”‚
â”‚  â”‚   Prompts: fabric-demo                           â”‚   â”‚
â”‚  â”‚   Updated: 2026-02-14                            â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚   [Re-provision Agents]  [Re-upload data â–¾]      â”‚   â”‚
â”‚  â”‚                          â”œâ”€ Graph                 â”‚   â”‚
â”‚  â”‚                          â”œâ”€ Telemetry             â”‚   â”‚
â”‚  â”‚                          â”œâ”€ Runbooks              â”‚   â”‚
â”‚  â”‚                          â”œâ”€ Tickets               â”‚   â”‚
â”‚  â”‚                          â””â”€ Prompts               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  [+ New Scenario]                                        â”‚
â”‚                                                          â”‚
â”‚ [Upload tab â€” standalone uploads for advanced users]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key changes from the original plan:**
- **Data Sources tab eliminated** â€” bindings shown inline on each scenario's
  expanded row. Click "Show details" or the chevron to expand.
- **2 tabs instead of 3**: `Scenarios | Upload`. The Upload tab stays for
  standalone re-uploads (power user flow), but most users never leave Scenarios.
- **Re-upload dropdown** on expanded rows: per-component upload (graph, telemetry,
  runbooks, tickets, prompts) using the same `UploadBox` component.
- **Click-to-activate** â€” clicking a non-active scenario activates it immediately
  (chip updates, row highlights). Brief green flash "Activated âœ“" confirms the action.
- **Custom mode bindings** shown as a collapsible section at top of list when
  `activeScenario === null`, with manual dropdowns.

**Delete confirmation with consequences:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Delete "telecom-v3"?                    â”‚
â”‚                                          â”‚
â”‚  This will permanently remove:           â”‚
â”‚  â€¢ Scenario metadata and configuration   â”‚
â”‚  â€¢ 42 graph vertices + edges             â”‚
â”‚  â€¢ Associated AI Search indices          â”‚
â”‚                                          â”‚
â”‚  Azure resources remain deployed.        â”‚
â”‚                                          â”‚
â”‚        [Cancel]    [Delete Scenario]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Change 4: ConnectionsDrawer â€” slide-over, not modal

A **right-edge slide-over** showing all connected backend services, grouped by role,
with expandable detail rows. Non-blocking â€” the main investigation UI remains visible
and dimmed underneath.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚  CONNECTIONS              âœ•  â”‚
â”‚   (main app content          â”‚                              â”‚
â”‚    still visible,            â”‚  CORE INFRASTRUCTURE         â”‚
â”‚    slightly dimmed)          â”‚  â— CosmosDB Gremlin    âœ“  â€º â”‚
â”‚                              â”‚  â— CosmosDB NoSQL      âœ“  â€º â”‚
â”‚                              â”‚  â— Blob Storage        âœ“  â€º â”‚
â”‚                              â”‚                              â”‚
â”‚                              â”‚  AI SERVICES                 â”‚
â”‚                              â”‚  â— Azure AI Foundry    âœ“  â€º â”‚
â”‚                              â”‚  â— Azure AI Search     âœ“  â€º â”‚
â”‚                              â”‚                              â”‚
â”‚                              â”‚  GRAPH BACKEND (OPTIONAL)    â”‚
â”‚                              â”‚  â—‹ Microsoft Fabric    â€”  âŒ„ â”‚
â”‚                              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                              â”‚    â”‚ Not configured.      â”‚  â”‚
â”‚                              â”‚    â”‚ Set FABRIC_WORKSPACE_ â”‚  â”‚
â”‚                              â”‚    â”‚ ID and FABRIC_GRAPH_  â”‚  â”‚
â”‚                              â”‚    â”‚ MODEL_ID env vars.   â”‚  â”‚
â”‚                              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                              â”‚
â”‚                              â”‚  Last checked: 12s ago  [â†»] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Drawer specs:**
- Width: `w-[420px]` fixed (desktop). Below `sm` breakpoint: full-width bottom sheet at `h-[70vh]`.
- Animation: slide in from right, 200ms ease-out (framer-motion spring).
- Backdrop: `bg-black/30`, click to close.
- Escape key closes.

**Services grouped by role:**
- **Core Infrastructure:** CosmosDB Gremlin, CosmosDB NoSQL, Blob Storage
- **AI Services:** Azure AI Foundry, Azure AI Search
- **Graph Backend (Optional):** Microsoft Fabric

**Each service row:**
- **Collapsed (default):** name, status dot (âœ“/âœ—/â€”), expand chevron â€º
- **Expanded:** endpoint info, last-checked timestamp, response time
- Connected services: full color, "Connected" badge
- Not-configured services: greyed out, "Not configured" badge + setup hint
- Errored services: red, "Error" badge + error message

**Fabric expanded section (when configured):**
```
â”‚  â— Microsoft Fabric    âœ“  âŒ„                   â”‚
â”‚    Workspace: telecom-ws                       â”‚
â”‚    Ontologies: 2  â”‚  Eventhouses: 1            â”‚
â”‚                                                â”‚
â”‚    â”Œâ”€â”€ Ontology â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ telecom-ontology (3 models)       [â–¾] â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”Œâ”€â”€ Eventhouses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ telecom-eh  â”‚  Type: Eventhouse       â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                â”‚
â”‚    [Provision Resources]  [Refresh]            â”‚
â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚    Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%                    â”‚
â”‚    Creating ontology...                        â”‚
```

**Footer:**
```
â”‚  Last checked: 12s ago  [â†» Refresh]            â”‚
â”‚  Manage scenarios â†’                             â”‚  â† text link to modal
```

**Data source:** `GET /api/services/health` â€” returns status of all configured
services. Each entry: `name`, `type`, `group`, `status` ("connected" | "not_configured" |
"error"), `details` (optional). Cached 30s server-side.

### Change 5: Non-blocking startup â€” restore silently, no overlay

**The key insight from audit:** Don't start with `null` â€” start with the persisted
scenario from `localStorage` and validate silently. Starting null causes a visible
blink for returning users (scenario active â†’ empty â†’ scenario restored).

**Startup flow:**

```
Returning user                        First-time user
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. localStorage has "telecom-v3"      1. localStorage is empty
2. activeScenario = "telecom-v3"      2. activeScenario = null
3. Skeleton chip while loading        3. Skeleton chip while loading
4. Background: validate vs Cosmos     4. Background: fetch scenario list
5. Still exists â†’ keep, crossfade     5. No scenarios â†’ EmptyState
   Deleted â†’ clear to null               Or has scenarios â†’ auto-select first?
6. Chip morphs from skeleton to real  6. Chip morphs from skeleton to real
```

**Implementation:**

```typescript
// ScenarioContext.tsx
const [activeScenario, setActiveScenario] = useState<string | null>(
  () => localStorage.getItem('activeScenario'), // preserve for returning users
);
const [scenariosLoading, setScenariosLoading] = useState(true);

useEffect(() => {
  fetch('/query/scenarios/saved')
    .then(r => r.json())
    .then(data => {
      const saved = (data.scenarios ?? []).map((s: {id: string}) => s.id);
      // Clear ghost scenario â€” otherwise keep what's already active
      if (activeScenario && !saved.includes(activeScenario)) {
        setActiveScenario(null);
        localStorage.removeItem('activeScenario');
      }
    })
    .catch(() => {}) // don't clear on network error
    .finally(() => setScenariosLoading(false));
}, []);
```

**Skeleton loading in ScenarioChip:**

```tsx
{scenariosLoading ? (
  <div className="h-7 w-36 rounded-full bg-white/5 animate-pulse" />
) : (
  <button ...> {/* real chip */} </button>
)}
```

**Crossfade on scenario restore** (framer-motion, already a dependency):

```tsx
<motion.div
  key={activeScenario ?? 'empty'}
  initial={{ opacity: 0 }}
  animate={{ opacity: 1 }}
  transition={{ duration: 0.2 }}
>
  {/* main content */}
</motion.div>
```

**Loading banner** (slim, non-blocking):

```tsx
{scenariosLoading && (
  <div className="bg-brand/10 text-brand text-xs px-4 py-1.5 text-center">
    Loading scenarios from CosmosDBâ€¦
  </div>
)}
```

**Remove entirely:** The `<AnimatePresence>` overlay block in `App.tsx` and the
`scenarioReady` state in `ScenarioContext.tsx`.

### Change 6: Interactive EmptyState â€” onboarding checklist

Replace the passive "No scenario loaded" + emoji steps with a **live onboarding
checklist** that reflects actual system state.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”‚              Get started                           â”‚
â”‚                                                    â”‚
â”‚  âœ“  API connected                                  â”‚
â”‚  âœ“  3 scenarios available                          â”‚
â”‚  â—‹  Select a scenario                              â”‚
â”‚     â†³ [Pick a scenario â–¾]  (inline chip)           â”‚
â”‚  â—‹  Agents not yet provisioned                     â”‚
â”‚     â†³ Auto-provisions on scenario select           â”‚
â”‚                                                    â”‚
â”‚  â”€â”€ or â”€â”€                                          â”‚
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  + Create New Scenario      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚  Services: 5/5 connected                           â”‚
â”‚  [View connections â†’]                              â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why this replaces the current EmptyState:**
- Each step reflects **real state** â€” API health, scenario count, agent readiness
- Inline scenario picker eliminates the "go find the chip in the header" scavenger hunt
- The CTA button directly opens AddScenarioModal â€” not passive text about a âš™ icon
- Cross-links to ConnectionsDrawer for users who need to verify setup
- No more emoji step indicators (ğŸ“‚â†’ğŸ¯â†’ğŸ¤–â†’ğŸ”) that describe a linear flow the UI
  doesn't actually enforce

**Data sources:** All from existing hooks/context â€” `healthStatus`, `scenarios`,
`activeScenario`, `provisioningStatus`. No new fetches needed.

### Change 7: Backend chooser in AddScenarioModal

Add a "Where should graph data live?" selector with descriptive cards.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHERE SHOULD GRAPH DATA LIVE?                       â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Azure CosmosDB          â”‚  â”‚  Microsoft Fabric â”‚â”‚
â”‚  â”‚  Gremlin graph database  â”‚  â”‚  GraphQL endpoint â”‚â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚  â”‚  âœ“ Default option        â”‚  â”‚  Requires Fabric  â”‚â”‚
â”‚  â”‚  âœ“ Fully managed         â”‚  â”‚  workspace setup  â”‚â”‚
â”‚  â”‚  âœ“ All data uploaded     â”‚  â”‚  via Connections   â”‚â”‚
â”‚  â”‚    via tarballs          â”‚  â”‚  panel first       â”‚â”‚
â”‚  â”‚                          â”‚  â”‚                    â”‚â”‚
â”‚  â”‚  [â— Selected]            â”‚  â”‚  [â—‹ Select]        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                      â”‚
â”‚  â„¹ Not sure? Use CosmosDB â€” it's the default and     â”‚
â”‚    requires no additional setup.                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Design decisions:**
- Label: "Where should graph data live?" â€” user-centric, not "GRAPH BACKEND"
- Each card has a description and implications (what's required, what you get)
- Fabric card greyed out with "Not available â€” configure in Connections" when
  Fabric isn't configured
- "Not sure?" hint eliminates decision paralysis for 90% of users
- Default: CosmosDB Gremlin (matches current behavior)
- User's explicit selection overrides any `connector` detected from tarball YAML
- Passed as `graph_connector` to `saveScenarioMeta()`

### Change 8: Bug fixes in useFabricDiscovery.ts

**B1 â€” Health check:** `data.status === 'ok'` â†’ `data.configured === true`

**B2 â€” Provision URL:** `/api/fabric/provision/pipeline` â†’ `/api/fabric/provision`

**B3 â€” Stale closure:** Remove `provisionState` from deps; use local `completed` flag

### Change 9: Micro-interactions and feedback

**Modal/panel animations** (framer-motion already available):

Centered modals (ScenarioManagerModal, AddScenarioModal):
```tsx
initial={{ opacity: 0, scale: 0.95, y: 10 }}
animate={{ opacity: 1, scale: 1, y: 0 }}
exit={{ opacity: 0, scale: 0.95, y: 10 }}
transition={{ duration: 0.15, ease: 'easeOut' }}
```

ConnectionsDrawer slide-over:
```tsx
initial={{ x: '100%' }}
animate={{ x: 0 }}
exit={{ x: '100%' }}
transition={{ type: 'spring', damping: 25, stiffness: 300 }}
```

**Toast notifications** for async outcomes:
- Add lightweight toast system (e.g., `sonner` â€” <5KB, or roll with framer-motion)
- Show transient success/error notifications for: provisioning, deletion, uploads,
  backend switching
- Success toasts auto-dismiss after 4s; error toasts persist until dismissed

**Scenario activation flash:**
- When clicking a non-active scenario in ScenarioManagerModal, the row flashes
  green with "Activated âœ“" for 1.5s â€” confirms the click did something without
  adding an "Apply" button

### Change 10: Accessibility gaps to close

| Gap | Fix | Effort |
|-----|-----|--------|
| No focus trap in modals | Wrap in focus trap (`@radix-ui/react-focus-trap` or manual) | Low |
| No `aria-live` for status | `aria-live="polite"` on loading banner, health changes, provisioning | Low |
| Chip dropdown not keyboard-navigable | `role="listbox"` + `role="option"` + arrow keys + `aria-activedescendant` | Med |
| Color-only health dots | Add text labels or icon shapes (âœ“/âœ—) alongside dots | Low |
| No skip-nav link | Visually-hidden "Skip to main content" as first focusable element | Low |


---

## Implementation Plan

### Phase A: Bug fixes + backend (do first, unblocks everything)

#### Task 1: Fix bugs in `useFabricDiscovery.ts`

**File:** `frontend/src/hooks/useFabricDiscovery.ts`

| Bug | Line | Fix |
|-----|------|-----|
| B1 | 69â€“73 | `data.status === 'ok'` â†’ `data.configured === true` |
| B2 | 136 | `/api/fabric/provision/pipeline` â†’ `/api/fabric/provision` |
| B3 | 130â€“163 | Remove `provisionState` dep; local `completed` flag |

#### Task 2: Add `GET /api/services/health` backend endpoint

**File:** New route in `graph-query-api/` (or `api/app/routers/`)

Returns grouped status for all configured Azure services:
```json
{
  "services": [
    {"name": "CosmosDB Gremlin", "type": "Graph Database", "group": "core", "status": "connected"},
    {"name": "Microsoft Fabric", "type": "Graph Database", "group": "optional", "status": "not_configured",
     "details": "Set FABRIC_WORKSPACE_ID and FABRIC_GRAPH_MODEL_ID env vars"}
  ],
  "summary": {"total": 6, "connected": 5, "not_configured": 1, "error": 0}
}
```

Services: CosmosDB Gremlin, CosmosDB NoSQL, Blob Storage, Azure AI Foundry,
Azure AI Search, Microsoft Fabric. Cached 30s server-side.

### Phase B: Startup flow (independent, no new components needed)

#### Task 3: Non-blocking startup

**Files:** `ScenarioContext.tsx`, `App.tsx`, `ScenarioChip.tsx`

1. `ScenarioContext.tsx` â€” init `activeScenario` from `localStorage` (not null);
   add `scenariosLoading` state; background-validate persisted scenario; remove
   `scenarioReady` state
2. `App.tsx` â€” remove `<AnimatePresence>` overlay; add slim loading banner;
   add crossfade transition on `activeScenario` change
3. `ScenarioChip.tsx` â€” skeleton pulse placeholder while `scenariosLoading`

### Phase C: Navigation restructure

#### Task 4: Extend ScenarioChip dropdown

**File:** `frontend/src/components/ScenarioChip.tsx`

1. Add third divider section with "âŠ Manage scenariosâ€¦" action
2. Clicking opens ScenarioManagerModal (rendered inside ScenarioChip)
3. Add backend badge to the active chip display: `[telecom-v3 Â· Cosmos â–¾]`

#### Task 5: Create ConnectionsDrawer

**File:** New `frontend/src/components/ConnectionsDrawer.tsx` (~280 lines)

Right-edge slide-over with:
1. Grouped service list (Core / AI / Optional)
2. Expandable rows (collapsed by default: name + status; expanded: details)
3. Fabric section (ontology browser, eventhouses, provision pipeline â€” migrated
   from SettingsModal Fabric tab)
4. Footer: "Last checked: Ns ago" + Refresh button + "Manage scenarios â†’" link
5. `w-[420px]` desktop, full-width bottom sheet below `sm` breakpoint
6. Spring animation, backdrop, Escape to close

#### Task 6: Update Header

**File:** `frontend/src/components/Header.tsx`

1. Remove `âš™` gear button + `settingsOpen` state + `<SettingsModal>` render
2. Replace `<HealthDot label="API" />` with ambient `<ServiceHealthSummary />`
   that shows "N/M Services" with aggregate color, polls `/api/services/health`,
   and is clickable (opens ConnectionsDrawer)
3. Add ğŸ”Œ connections button with status dot overlay â†’ opens ConnectionsDrawer
4. Add `connectionsOpen` state + `<ConnectionsDrawer>` render

#### Task 7: Create ScenarioManagerModal (simplified from SettingsModal)

**File:** Refactor `SettingsModal.tsx` â†’ `ScenarioManagerModal.tsx`

1. Remove Fabric tab (moved to ConnectionsDrawer)
2. Remove Data Sources tab (inlined into scenario rows)
3. Change title "Settings" â†’ "Manage Scenarios"
4. Keep 2 tabs: `Scenarios | Upload`
5. Scenarios tab: expandable rows with inline bindings, re-provision button,
   re-upload dropdown per scenario
6. Click-to-activate with green flash confirmation
7. Delete confirmation shows consequences (vertex count, etc.)
8. Upload tab: standalone UploadBox components (unchanged, for power users)
9. Add framer-motion enter/exit animations

### Phase D: Scenario creation + EmptyState

#### Task 8: Backend chooser in AddScenarioModal

**File:** `frontend/src/components/AddScenarioModal.tsx`

1. Add `fabricAvailable` state + `/query/fabric/health` check on open
2. Add `selectedBackend` state (default: `'cosmosdb-gremlin'`)
3. Render "Where should graph data live?" cards with descriptions
4. Fabric card greyed out when not configured; "Not sure?" hint below
5. `selectedBackend` overrides `detectedConnector` in save
6. Remove `detectedConnector` banner

#### Task 9: Interactive EmptyState

**File:** `frontend/src/components/EmptyState.tsx`

1. Replace static step indicators with live onboarding checklist
2. Steps reflect real state: API health, scenario count, agent readiness
3. Inline scenario picker for "Select a scenario" step
4. CTA button: "+ Create New Scenario" â†’ opens AddScenarioModal
5. Service health summary + "View connections â†’" link

### Phase E: Polish + cleanup

#### Task 10: Micro-interactions

1. Modal/panel enter/exit animations (framer-motion)
2. Toast notification system for async outcomes
3. Scenario activation flash in manager modal

#### Task 11: Accessibility

1. Focus trap in all modals/drawers
2. `aria-live="polite"` on dynamic status regions
3. Keyboard navigation for ScenarioChip dropdown
4. Color-independent status indicators (text labels + icons)
5. Skip-nav link

#### Task 12: Delete SettingsModal + cleanup

1. Remove `SettingsModal.tsx`
2. Clean up all imports referencing it
3. Remove `scenarioReady` from ScenarioContext exports/consumers

#### Task 13: Update architecture docs

- `frontend-architecture.md` â€” document new component structure
- `project-structure.md` â€” update file list
- `backlog-and-future.md` â€” mark done

---

## File Change Inventory

### New Files (3)

| File | Task | Size |
|------|------|------|
| `frontend/src/components/ConnectionsDrawer.tsx` | 5 | ~280 lines |
| `frontend/src/components/ServiceHealthSummary.tsx` | 6 | ~60 lines |
| Backend services health endpoint (TBD location) | 2 | ~80 lines |

### Heavily Modified (4)

| File | Task | Change |
|------|------|--------|
| `SettingsModal.tsx` â†’ `ScenarioManagerModal.tsx` | 7 | Remove Fabric + Data Sources tabs, add inline bindings, simplify (~860â†’~550 lines) |
| `ScenarioChip.tsx` | 4 | Add manage action, backend badge on chip, skeleton state (~176â†’~210 lines) |
| `ScenarioContext.tsx` | 3 | Remove scenarioReady, init from localStorage, add scenariosLoading (~185â†’~170 lines) |
| `EmptyState.tsx` | 9 | Replace passive text with interactive checklist (~60â†’~100 lines) |

### Medium Edits (3)

| File | Task | Change |
|------|------|--------|
| `Header.tsx` | 6 | Remove gear, add ambient health + connections button (~72â†’~80 lines) |
| `AddScenarioModal.tsx` | 8 | Backend chooser cards (~705â†’~760 lines) |
| `App.tsx` | 3 | Remove overlay, add crossfade + loading banner (~217â†’~210 lines) |

### Small Edits (1)

| File | Task | Change |
|------|------|--------|
| `useFabricDiscovery.ts` | 1 | 3 bug fixes (~15 lines changed) |

### Deleted (1)

| File | Task |
|------|------|
| `SettingsModal.tsx` | 12 |

---

## User Flows: Before vs After

### Startup (returning user)

```
BEFORE:                                 AFTER:
Full-screen dark overlay                App renders immediately with scenario
"Validating scenario..."               Skeleton chip pulses briefly
5s max blocking                         Background validation (invisible)
User stares at spinner                  Crossfade â†’ real chip when done
```

### Startup (first-time user)

```
BEFORE:                                 AFTER:
Same dark overlay (no scenario)         EmptyState with live checklist
Then empty state with emoji steps       âœ“ API connected, âœ“ N scenarios
Says "Open âš™ Settings"                 Inline scenario picker + CTA button
```

### "I want to manage my scenarios"

```
BEFORE:                                 AFTER:
Click âš™ gear                           Click ScenarioChip â–¾
Opens big "Settings" modal              See scenario list in dropdown
Navigate to "Scenarios" tab             Click "âŠ Manage scenariosâ€¦"
Scroll through list                     Focused modal opens â€” scenarios with
Click scenario to select                 inline bindings, re-upload, re-provision
```

### "I want to see what's connected"

```
BEFORE:                                 AFTER:
Click âš™ gear                           Glance at header: "5/5 Services" (green)
?? No connections view                  â€” OR â€” click ğŸ”Œ
Only a small "API" green dot            Slide-over shows all services grouped:
                                          Core: â— CosmosDB âœ“, â— Blob âœ“
                                          AI: â— Foundry âœ“, â— Search âœ“
                                          Optional: â—‹ Fabric â€” Not configured
```

### "I want to set up Fabric"

```
BEFORE:                                 AFTER:
1. Can't see Fabric tab (chicken-egg)   1. Click ğŸ”Œ Connections
2. Manually edit YAML, upload tarball   2. Expand Fabric row â†’ see status
3. Fabric tab appears... maybe          3. If configured: browse ontologies,
4. Health always shows broken (bug)        provision resources
5. Provision button 404s (bug)          4. Health works (bug fixed)
6. ???                                  5. Provision works (bug fixed)
                                        6. Create scenario with Fabric chooser
```

### "I want to create a Fabric scenario"

```
1. Click ğŸ”Œ â†’ verify Fabric is Connected + resources provisioned
2. Click [ScenarioChip â–¾] â†’ "+ New Scenario"
3. "Where should graph data live?" â†’ select Fabric card
4. Upload tarballs â†’ scenario saved with graph_connector: "fabric-gql"
5. Scenario chip shows [factory-demo Â· Fabric â–¾] with cyan badge
```

---

## Edge Cases

### Fabric env vars not set
- `/api/services/health` returns Fabric as `"not_configured"` in optional group
- ConnectionsDrawer shows Fabric greyed out with setup hint
- AddScenarioModal Fabric card greyed out: "Not available â€” configure in Connections"
- Ambient health shows "5/5 Services" (Fabric doesn't count toward total when not configured)
- Pure CosmosDB experience â€” zero Fabric UI surface

### Mixed deployment (Cosmos + Fabric both configured)
- ConnectionsDrawer shows all services including Fabric as Connected
- Backend chooser in AddScenarioModal shows both options with descriptions
- Existing scenarios unaffected

### No persisted scenario in localStorage
- `activeScenario = null` â†’ EmptyState renders immediately with checklist
- Skeleton chip briefly, then real chip with "(No scenario)"
- User picks from inline chip or CTA button

### Persisted scenario was deleted in backend
- App starts with persisted scenario (looks normal)
- Background validation detects missing â†’ `setActiveScenario(null)`
- Crossfade to EmptyState â€” no jarring overlay, just a smooth transition
- `localStorage` cleared silently

### API is down on startup
- Ambient health shows "0/M Services" in red
- `scenariosLoading` finishes with error â†’ no scenario change
- If scenario was persisted, it stays active (don't clear on network error)
- User sees their last state; health summary surfaces the problem

### Service degrades during investigation
- Ambient "5/5 Services" updates to "4/5 Services" in amber on next 30s poll
- User notices the count/color change without interruption
- Clicks to open ConnectionsDrawer â†’ sees which service is down
- No popup, no modal, no interruption â€” just ambient awareness

---

## Audit Resolution Log

Decisions made when reconciling overlapping or contradictory recommendations from
v11ui1.md and v11ui2.md:

| Topic | v11ui1 | v11ui2 | Resolution |
|-------|--------|--------|------------|
| **Header buttons** | Merge both into chip dropdown; zero new buttons | Merge âŠ into dropdown; keep ğŸ”Œ as header button with status dot | **Hybrid:** âŠ in dropdown (both agree), ğŸ”Œ stays in header with status dot (ui2). Ambient health summary replaces HealthDot (ui1). Net: same button count. |
| **Startup init** | Start with persisted scenario, not null | Add skeleton + crossfade on restore | **Both adopted.** Init from localStorage (ui1), add skeleton chip (ui2 R2), add crossfade (ui2 R3). |
| **ConnectionsPanel format** | Slide-over drawer (right-edge) | Slide-over drawer (right-edge, 420px) | **Unanimous.** Slide-over with ui2's specific specs (width, spring animation, backdrop). |
| **Data Sources tab** | Kill it; inline bindings into scenario rows | Keep ScenarioManagerModal but add badge to chip (R11) | **ui1 wins.** Inline bindings give better context. Modal reduced to 2 tabs. |
| **Service health visibility** | Ambient "N/M Services" in header (replace API dot) | Status dot overlay on ğŸ”Œ icon | **Both adopted.** Ambient summary replaces HealthDot AND ğŸ”Œ has overlay dot. Two ambient indicators, both passive. |
| **EmptyState** | Actionable with CTA button + service health link | Interactive checklist with live state + inline scenario picker | **ui2 wins â€” more sophisticated.** Checklist with real state beats a simple CTA card. |
| **Backend chooser framing** | "Where should graph data live?" with descriptive cards | "GRAPH BACKEND" with descriptions + "Not sure?" hint | **Merged.** ui1's question framing + ui2's "Not sure?" hint. Both had description cards. |
| **Scenario activation** | Click-to-activate with green flash | Not addressed | **Adopted from ui1.** Flash confirmation is low-cost, high-clarity. |
| **Service grouping** | Not addressed | Group by role (Core/AI/Optional) | **Adopted from ui2.** Gives visual rhythm and architecture understanding. |
| **Expandable rows** | Not addressed | Collapsed by default, expand for details | **Adopted from ui2.** Keeps panel scannable. |
| **Last-checked timestamp** | Not addressed | "Last checked: Ns ago" + Refresh | **Adopted from ui2.** Gives users agency and confidence. |
| **Delete confirmation** | Not addressed | Show consequences (vertex count, etc.) | **Adopted from ui2.** Better than generic "Are you sure?" |
| **Animations** | Not addressed | Enter/exit animations for all panels | **Adopted from ui2.** Low-cost (framer-motion exists), high-polish. |
| **Toasts** | Not addressed | Toast system for async outcomes | **Adopted from ui2.** Fills feedback gaps for provisioning, deletion, uploads. |
| **Accessibility** | Not addressed | Focus trap, aria-live, keyboard nav, skip-nav | **Adopted from ui2.** High-impact for real users, medium effort. |
| **âš™ deprecation** | Not addressed | Keep dimmed âš™ as grace period (R7) | **Deferred.** Nice courtesy but adds clutter. Add keyboard shortcut Ctrl+, instead. |
| **Mobile responsive** | Not addressed | Bottom sheet below sm, max-w adjustments (R17) | **Partially adopted.** ConnectionsDrawer becomes bottom sheet on mobile. Modals get `max-w-full mx-2`. Full mobile effort deferred. |
