# V11b: Terminal Visibility Overhaul

## Problem

The current log terminal has two issues:

1. **Only 2 streams** — "API" (container/orchestrator logs) and "Graph API" (query service logs). Data operations (Cosmos writes, blob uploads, AI Search indexing, Fabric provisioning) happen deep inside these services but are mixed in with hundreds of other log lines. When an upload fails or Cosmos throttles, finding the relevant log line is needle-in-haystack.

2. **Logs only flow when scenario is active** — The log terminals (`MetricsBar` → `TabbedLogStream`) are inside the investigation panel, which only renders when a scenario is selected. On first launch (empty state), there are **zero terminals visible**. If the user uploads data from the empty state and something fails, they have no visibility.

## Solution

### 1. Add a third "Data Ops" log stream

A dedicated terminal tab that streams only data-operation logs: Cosmos CRUD, blob uploads, AI Search indexing, Gremlin ingestion, Fabric provisioning, ARM resource creation.

**Backend**: Both services already have logger names that identify data operations:

| Logger name | Service | What it covers |
|-------------|---------|----------------|
| `graph-query-api.ingest` | graph-query-api | All upload endpoints (graph, telemetry, knowledge, prompts) |
| `graph-query-api.cosmos` | graph-query-api | Cosmos client operations (get_mgmt_client, container creation) |
| `graph-query-api.indexer` | graph-query-api | AI Search index creation and management |
| `graph-query-api.blob` | graph-query-api | Blob storage uploads |
| `app.fabric-provision` | api | Fabric workspace/lakehouse/eventhouse/ontology provisioning |
| `api.config` | api | Agent provisioning (Cosmos prompt fetch, config persistence) |

**Implementation**: Add a new SSE endpoint that filters to data-operation loggers only.

### 2. Divorce log terminals from scenario loading

Move the tabbed log stream out of `MetricsBar` (which is inside the investigation panel, gated on `activeScenario`) and into a persistent bottom panel that renders regardless of application state.

The graph topology viewer stays in `MetricsBar` (scenario-dependent), but the terminals become always-visible infrastructure.

## Design

### Current layout
```
┌─────────────────────────────────────────────┐
│ Header                                      │
├─────────────────────────────────────────────┤
│ TabBar                                      │
├─────────────────────────────────────────────┤
│                                             │
│  (empty state — no terminals visible)       │
│                                             │
│  OR                                         │
│                                             │
│  MetricsBar (graph + 2 terminals)           │  ← only when scenario active
│  Investigation + Diagnosis                  │
│                                             │
└─────────────────────────────────────────────┘
```

### New layout
```
┌─────────────────────────────────────────────┐
│ Header                                      │
├─────────────────────────────────────────────┤
│ TabBar                                      │
├─────────────────────────────────────────────┤
│                                             │
│  Main content area                          │
│  (empty state / investigation / resources)  │
│                                             │
├─────────────────────────────────────────────┤  ← resizable divider
│ ┌─────────┬───────────┬──────────┐          │
│ │ API     │ Graph API │ Data Ops │          │  ← always visible, 3 tabs
│ ├─────────┴───────────┴──────────┤          │
│ │ 14:31:02 INFO app.config: ...  │          │
│ │ 14:31:03 INFO cosmos: upsert.. │          │
│ └────────────────────────────────┘          │
└─────────────────────────────────────────────┘
```

The terminal panel:
- **Always renders** — visible on empty state, during uploads, during investigation
- **Collapsible** — user can drag the divider down to minimize or click a toggle
- **3 tabs**: API, Graph API, Data Ops
- **Starts streaming immediately** on page load (SSE connects on mount, not on scenario select)

## Implementation Plan

### Phase 1 — Backend: Data Ops log endpoint (~20 lines)

**graph-query-api/main.py** — Add a second LogBroadcaster filtered to data-operation loggers:

```python
# Existing: streams ALL graph-query-api.* logs
_log_broadcaster = LogBroadcaster(...)

# New: streams ONLY data-operation logs
_data_ops_broadcaster = LogBroadcaster(max_buffer=200, max_queue=500)
_data_ops_handler = _data_ops_broadcaster.get_handler(level=logging.DEBUG)
_data_ops_handler.setFormatter(...)
_data_ops_handler.addFilter(
    lambda r: r.name.startswith((
        "graph-query-api.ingest",
        "graph-query-api.cosmos",
        "graph-query-api.indexer",
        "graph-query-api.blob",
    ))
)
logging.getLogger().addHandler(_data_ops_handler)

@app.get("/query/logs/data-ops")
async def stream_data_ops_logs():
    return StreamingResponse(
        _data_ops_broadcaster.subscribe(),
        media_type="text/event-stream",
        headers={"Cache-Control": "no-cache", "X-Accel-Buffering": "no"},
    )
```

**api/app/routers/logs.py** — Add a second broadcaster for Fabric + provisioning logs:

```python
_data_ops_broadcaster = LogBroadcaster(max_buffer=200, max_queue=500)
_data_ops_handler = _data_ops_broadcaster.get_handler(level=logging.DEBUG)
_data_ops_handler.addFilter(
    lambda r: r.name.startswith(("app.fabric", "api.config"))
)
logging.getLogger().addHandler(_data_ops_handler)

@router.get("/logs/data-ops")
async def stream_data_ops_logs():
    return EventSourceResponse(_data_ops_broadcaster.subscribe(), ...)
```

The frontend `LogStream` component already supports arbitrary URLs — just add a third stream definition.

### Phase 2 — Frontend: Persistent terminal panel (~50 lines)

#### 2a. Create `TerminalPanel.tsx`

A new component that wraps `TabbedLogStream` with 3 streams and renders independently of scenario state:

```tsx
const LOG_STREAMS = [
  { url: '/api/logs', title: 'API' },
  { url: '/query/logs', title: 'Graph API' },
  { url: '/api/logs/data-ops', title: 'Data Ops' },
];

export function TerminalPanel() {
  return (
    <div className="h-full">
      <TabbedLogStream streams={LOG_STREAMS} />
    </div>
  );
}
```

#### 2b. Update `App.tsx` layout

Move from:
```
<PanelGroup vertical>
  <MetricsBar />        ← contains graph + terminals, only when scenario active
  <Investigation />
</PanelGroup>
```

To:
```
<PanelGroup vertical>
  <MainContent />       ← empty state / investigation / resources (existing)
  <TerminalPanel />     ← always visible, resizable
</PanelGroup>
```

The vertical `PanelGroup` already exists in App.tsx — just move the terminal panel outside the scenario-gated section.

#### 2c. Update `MetricsBar.tsx`

Remove the `TabbedLogStream` from MetricsBar. It becomes just the graph topology viewer (which is already scenario-dependent — that's correct, since topology needs data to display).

```tsx
// Before: PanelGroup with graph (64%) + logs (36%)
// After: Just the graph viewer, full width
export function MetricsBar() {
  return (
    <div className="h-full px-6 py-3">
      <GraphTopologyViewer width={...} height={...} />
    </div>
  );
}
```

### Phase 3 — Data Ops stream aggregation (optional enhancement)

The "Data Ops" tab currently has two sources:
- `/api/logs/data-ops` — Fabric provisioning, agent config
- `/query/logs/data-ops` — Cosmos, blob, search, ingest

For a single unified "Data Ops" tab, the `LogStream` component would need to connect to **two** SSE sources and merge them chronologically. Options:

**Option A — Frontend merge** (simple):
Enhance `LogStream` to accept `url: string | string[]`. When array, open multiple `EventSource` connections and merge entries by timestamp.

**Option B — Backend proxy** (cleaner):
Add a single `/api/logs/data-ops` endpoint in the API service that:
1. Broadcasts its own data-ops logs (Fabric, config)
2. Also connects to `http://127.0.0.1:8100/query/logs/data-ops` internally and re-broadcasts those entries

This gives one SSE connection to the frontend. More work but simpler frontend.

**Recommendation**: Option A for v11b — it's 10 lines of frontend change and avoids cross-service HTTP complexity.

## Files Changed

| File | Change |
|------|--------|
| `graph-query-api/main.py` | Add `/query/logs/data-ops` endpoint with filtered broadcaster |
| `api/app/routers/logs.py` | Add `/api/logs/data-ops` endpoint with filtered broadcaster |
| `frontend/src/components/TerminalPanel.tsx` | **New** — persistent 3-tab terminal |
| `frontend/src/components/LogStream.tsx` | Support `url: string \| string[]` for multi-source merge |
| `frontend/src/App.tsx` | Add `TerminalPanel` outside scenario gate, wrap in resizable panel |
| `frontend/src/components/MetricsBar.tsx` | Remove `TabbedLogStream`, become graph-only |
| `frontend/src/components/TabbedLogStream.tsx` | Update stream definitions (or delete if inlined into TerminalPanel) |

## Risk

**Low.** All changes are additive — new SSE endpoints, new UI panel. No existing behavior changes. The only visual change is moving terminals from inside the investigation panel to a persistent bottom bar.

## Effort

- Phase 1 (backend endpoints): ~30 min
- Phase 2 (frontend layout): ~1 hour  
- Phase 3 (multi-source merge): ~30 min

Total: ~2 hours
