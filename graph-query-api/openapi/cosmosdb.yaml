openapi: "3.0.3"
info:
  title: Graph Query API
  version: "0.5.0"
  description: |
    Micro-API for executing Gremlin and Cosmos SQL queries.
    Used by Foundry agents via OpenApiTool.
    Backend: Azure Cosmos DB for Apache Gremlin + NoSQL
# NOTE: Template placeholders ({base_url}, etc.) are substituted
# at runtime by scripts/provision_agents.py.
servers:
  - url: "{base_url}"
    description: Deployed Container App

paths:
  /query/graph:
    post:
      operationId: query_graph
      summary: Execute a Gremlin query against the Cosmos DB graph
      description: |
        Submits a Gremlin traversal query to Azure Cosmos DB for Apache Gremlin.
        Returns columns and data rows from the network topology ontology.
        Use this to query routers, links, switches, base stations, MPLS paths,
        services, SLA policies, and BGP sessions.

        Send Gremlin queries as plain text strings (no bytecode, no lambdas).
        Cosmos DB configuration (endpoint, database, graph) is set server-side.
      parameters:
        - name: X-Graph
          in: header
          required: true
          schema:
            type: string
            enum: ["{graph_name}"]
          description: |
            The graph name to route this request to. Always use the value shown.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                  description: |
                    A Gremlin traversal query string. Use exact entity IDs (uppercase with hyphens).
                    Never use lambdas â€” Cosmos DB only supports string-based Gremlin.
                    Example:
                    g.V().hasLabel('TransportLink').has('LinkId', 'LINK-SYD-MEL-FIBRE-01')
                      .in('routes_via').hasLabel('MPLSPath').valueMap(true)
      responses:
        "200":
          description: Query results (check 'error' field for query failures)
          content:
            application/json:
              schema:
                type: object
                properties:
                  columns:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        type:
                          type: string
                  data:
                    type: array
                    items:
                      type: object
                  error:
                    type: string
                    nullable: true
                    description: |
                      If present, the query failed. Contains the error message.
                      Read the message, fix your query, and retry.

  /query/telemetry:
    post:
      operationId: query_telemetry
      summary: Execute a SQL query against telemetry data in Cosmos DB
      description: |
        Submits a Cosmos SQL query to a telemetry container in Azure Cosmos DB NoSQL.
        Returns columns and rows of alert or telemetry data.
        Containers available: AlertStream (~5000 docs), LinkTelemetry (~8640 docs).
        Use standard SQL syntax: SELECT, FROM c, WHERE, ORDER BY, TOP, GROUP BY.
      parameters:
        - name: X-Graph
          in: header
          required: true
          schema:
            type: string
            enum: ["{graph_name}"]
          description: |
            The graph name to route this request to. Always use the value shown.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
                - container_name
              properties:
                query:
                  type: string
                  description: |
                    A Cosmos SQL query string.
                    Always use FROM c as the alias.
                    Example: SELECT c.AlertId, c.Severity, c.Description FROM c WHERE c.Severity = 'CRITICAL' ORDER BY c.Timestamp DESC OFFSET 0 LIMIT 5
                container_name:
                  type: string
                  enum: ["AlertStream", "LinkTelemetry"]
                  description: |
                    The Cosmos DB container to query.
                    Use "AlertStream" for network alerts.
                    Use "LinkTelemetry" for link telemetry readings.
      responses:
        "200":
          description: Query results (check 'error' field for query failures)
          content:
            application/json:
              schema:
                type: object
                properties:
                  columns:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        type:
                          type: string
                  rows:
                    type: array
                    items:
                      type: object
                  error:
                    type: string
                    nullable: true
                    description: |
                      If present, the query failed. Contains the error message.
                      Read the message, fix your query, and retry.
