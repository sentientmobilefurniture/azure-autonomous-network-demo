# V11E — Fabric Connection Manager + Background Uploads

> **Status:** Not started
> **Depends on:** v11fabricv3 (Phase B+C complete)
> **Effort:** ~6 hours

---

## 1. What This Changes

**Before:** 3-step Wizard (Connect → Provision → Create Scenario) conflates workspace connection with resource provisioning. The Provision step shows Lakehouse/Ontology/Eventhouse status, but those resources are created during data upload, not during workspace setup.

**After:**
- **Fabric Connections** is a simple single-screen panel: add a workspace ID+name, select from saved connections. No provisioning UI.
- **Data upload** (AddScenarioModal) handles the Lakehouse → Ontology pipeline when the graph tarball is uploaded with Fabric backend selected.
- **Background uploads** run server-side so they survive modal close and browser refresh. A status panel shows progress.

---

## 2. Fabric Connections Panel

### 2.1 Backend

**File:** New `graph-query-api/router_fabric_connections.py`  
**Register in:** `graph-query-api/main.py`  
**Prefix:** `/query/fabric/connections`

Cosmos container: `fabric-connections` (partition key `/id`)

```json
{
  "id": "4a4ff69c-18dd-4f32-9a18-e9e9a03f06f9",
  "workspace_id": "4a4ff69c-18dd-4f32-9a18-e9e9a03f06f9",
  "workspace_name": "cosmosfab1",
  "created_at": "2026-02-17T12:00:00Z",
  "last_used": "2026-02-17T12:00:00Z",
  "active": true
}
```

| Method | Path | Purpose |
|---|---|---|
| `GET` | `/query/fabric/connections` | List all saved connections (sorted by `last_used` desc) |
| `POST` | `/query/fabric/connections` | Add new connection (validates workspace reachable). Upserts if ID exists. |
| `DELETE` | `/query/fabric/connections/{id}` | Remove a saved connection |
| `POST` | `/query/fabric/connections/{id}/select` | Set as active workspace. Writes to `fabric-config` doc in Cosmos. |

Active workspace config is persisted in Cosmos (not env vars — env vars don't survive container restarts and the managed identity can't update its own Container App). Both services read via `fetch_fabric_config()` with 60s TTL cache.

### 2.2 Frontend

**File:** New `frontend/src/components/FabricConnectionPanel.tsx` (replaces `FabricSetupWizard.tsx`)

Single-screen modal using `<ModalShell>`:

```
┌──────────────────────────────────────────────────────────────┐
│  Fabric Workspaces                                       ✕  │
│                                                              │
│  ┌─ Add Connection ─────────────────────────────────────┐    │
│  │  Workspace ID    [_______________________________]   │    │
│  │  Workspace Name  [_______________________________]   │    │
│  │                                 [+ Add Connection]   │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│  Saved Connections                                           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ ● cosmosfab1                           2 minutes ago │    │
│  │   4a4ff69c-18dd-4f32-9a18-e9e9a03f06f9           ✕   │    │
│  └──────────────────────────────────────────────────────┘    │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ ○ dev-workspace                        3 days ago    │    │
│  │   8b1234ab-5678-90cd-ef12-34567890abcd           ✕   │    │
│  └──────────────────────────────────────────────────────┘    │
│                                                              │
│                                     [Close]  [Save]          │
└──────────────────────────────────────────────────────────────┘
```

- Vertical list, one connection per row, full width
- Selected row: brand border + filled radio dot
- ✕ delete on hover
- **Save** calls `POST /query/fabric/connections/{id}/select` and closes
- **Save disabled** when nothing selected
- On mount: fetch connections, pre-select the currently active one

---

## 3. Graph Upload → Fabric Pipeline

### Problem

When Fabric is selected in AddScenarioModal, the graph slot shows a static "✓ Loaded from Fabric Lakehouse" card. The user can't upload anything. The graph tarball needs to trigger the Lakehouse → Ontology → Graph Model pipeline.

### 3.1 Frontend: Normal upload slot with Fabric label

**File:** `AddScenarioModal.tsx`

Delete the static confirmation card branch (`if graph && fabric-gql`). When Fabric is selected, show a normal `FileSlot` with label: "Graph Data (Fabric) — will be loaded into Lakehouse".

### 3.2 Frontend: Route to Fabric endpoint

**File:** `useScenarioUpload.ts`

When `selectedBackend === "fabric-gql"` and slot is `graph`:
- Upload to `POST /api/fabric/provision/graph` instead of `POST /query/upload/graph`
- Pass `workspace_id` from active connection
- SSE progress shows Fabric labels ("Uploading to Lakehouse…", "Building ontology…")

### 3.3 Backend: Graph tarball → Fabric pipeline

**File:** `api/app/routers/fabric_provision.py`

Add `POST /api/fabric/provision/graph`:
1. Receive tarball (multipart)
2. Extract entity CSVs to temp directory
3. Upload to OneLake Lakehouse (`_upload_csvs_to_onelake`)
4. Load delta tables (`_load_delta_tables`)
5. Create/update Ontology (`_build_ontology_definition` + `_apply_ontology_definition`)
6. Discover Graph Model (`_discover_graph_model`)
7. Stream SSE progress

Reuses existing B1–B4 functions already in `fabric_provision.py`.

---

## 4. Background Uploads + Status Panel

### Problem

Uploads run in the browser's fetch stream. Close modal or refresh → upload dies. Fabric ontology indexing takes 30-45 min.

### 4.1 Backend: Upload jobs

**File:** New `api/app/routers/upload_jobs.py`

Cosmos container: `upload-jobs` (partition key `/id`)

```json
{
  "id": "job-uuid",
  "scenario_name": "telco-noc-fabric",
  "status": "running",
  "created_at": "2026-02-17T12:00:00Z",
  "updated_at": "2026-02-17T12:05:00Z",
  "overall_pct": 25,
  "error": null,
  "steps": [
    { "name": "graph", "status": "done", "detail": "Uploaded to Lakehouse", "pct": 100 },
    { "name": "telemetry", "status": "running", "detail": "AlertStream.csv…", "pct": 45 },
    { "name": "runbooks", "status": "pending" },
    { "name": "tickets", "status": "pending" },
    { "name": "prompts", "status": "pending" },
    { "name": "agents", "status": "pending" }
  ]
}
```

| Method | Path | Purpose |
|---|---|---|
| `POST` | `/api/upload-jobs` | Create job + accept files (multipart). Starts background task. Returns `201 { job_id }` immediately. |
| `GET` | `/api/upload-jobs` | List all jobs |
| `GET` | `/api/upload-jobs/{id}` | Full job with per-step status |
| `DELETE` | `/api/upload-jobs/{id}` | Remove completed/failed job |

Background task processes steps sequentially, writes status to Cosmos after each. If graph + fabric-gql → Lakehouse pipeline. On server restart → marks running jobs as `error`.

### 4.2 Frontend: Status Panel

**File:** New `frontend/src/components/ScenarioStatusPanel.tsx`

```
┌──────────────────────────────────────────────────────┐
│  Uploads                                         ✕   │
│                                                      │
│  ┌──────────────────────────────────────────────┐    │
│  │ telco-noc-fabric              ⟳ Running  45% │    │
│  │  ├─ ✓ Graph          Uploaded to Lakehouse   │    │
│  │  ├─ ⟳ Telemetry      AlertStream.csv… 45%    │    │
│  │  ├─ ○ Runbooks                               │    │
│  │  ├─ ○ Tickets                                │    │
│  │  ├─ ○ Prompts                                │    │
│  │  └─ ○ Agents                                 │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  ┌──────────────────────────────────────────────┐    │
│  │ telco-noc                     ✓ Done   100%  │    │
│  │  ├─ ✓ Graph          34 vertices, 47 edges   │    │
│  │  └─ ...                                      │    │
│  └──────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────┘
```

- Polls every 5s while any job is running
- Tree: scenario name + overall % at top, steps below
- Past uploads persist in Cosmos — visible across sessions/browsers
- Failed steps show error + retry
- Entry: button in Header with badge for running count

### 4.3 Wire AddScenarioModal

"Save Scenario" → `POST /api/upload-jobs` with files → receive `job_id` → close modal immediately. Status panel tracks progress.

---

## 5. Implementation Steps

| # | Task | File |
|---|------|------|
| 1 | Connection CRUD endpoints | `graph-query-api/router_fabric_connections.py` (new) |
| 2 | Register connection router | `graph-query-api/main.py` |
| 3 | FabricConnectionPanel | `frontend/src/components/FabricConnectionPanel.tsx` (new) |
| 4 | Delete FabricSetupWizard | `frontend/src/components/FabricSetupWizard.tsx` → delete |
| 5 | Fix graph slot for Fabric | `frontend/src/components/AddScenarioModal.tsx` |
| 6 | Graph tarball → Fabric endpoint | `api/app/routers/fabric_provision.py` |
| 7 | Route graph upload by backend | `frontend/src/hooks/useScenarioUpload.ts` |
| 8 | Upload jobs backend | `api/app/routers/upload_jobs.py` (new) |
| 9 | Register upload jobs router | `api/app/main.py` |
| 10 | Scenario Status Panel | `frontend/src/components/ScenarioStatusPanel.tsx` (new) |
| 11 | Header: swap wizard for panel + status | `frontend/src/components/Header.tsx` |
| 12 | Modal → background job | `frontend/src/components/AddScenarioModal.tsx` |

---

## 6. File Changes

| File | Change |
|---|---|
| `graph-query-api/router_fabric_connections.py` | New — connection CRUD |
| `graph-query-api/main.py` | Register router |
| `frontend/src/components/FabricConnectionPanel.tsx` | New — replaces FabricSetupWizard |
| `frontend/src/components/FabricSetupWizard.tsx` | Delete |
| `frontend/src/components/ScenarioStatusPanel.tsx` | New — upload status tree |
| `frontend/src/components/Header.tsx` | Swap wizard for connection panel, add status button |
| `frontend/src/components/AddScenarioModal.tsx` | Fix graph slot, wire to background jobs |
| `frontend/src/hooks/useScenarioUpload.ts` | Route graph to Fabric endpoint, submit as job |
| `api/app/routers/fabric_provision.py` | Add `POST /api/fabric/provision/graph` |
| `api/app/routers/upload_jobs.py` | New — job CRUD + background task |
| `api/app/main.py` | Register upload jobs router |
