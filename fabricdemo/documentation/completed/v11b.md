# V11b: Terminal Visibility Overhaul

## Problem

The current log terminal has two issues:

1. **Only 2 streams** — "API" (container/orchestrator logs) and "Graph API" (query service logs). Data operations (Cosmos writes, blob uploads, AI Search indexing, Fabric provisioning) happen deep inside these services but are mixed in with hundreds of other log lines. When an upload fails or Cosmos throttles, finding the relevant log line is needle-in-haystack.

2. **Logs only flow when scenario is active** — The log terminals (`MetricsBar` → `TabbedLogStream`) are inside the investigation panel, which only renders when a scenario is selected. On first launch (empty state), there are **zero terminals visible**. If the user uploads data from the empty state and something fails, they have no visibility.

## Solution

### 1. Add a third "Data Ops" log stream

A dedicated terminal tab that streams only data-operation logs: Cosmos CRUD, blob uploads, AI Search indexing, Gremlin ingestion, Fabric provisioning, ARM resource creation.

**Backend**: Both services already have logger names that identify data operations:

| Logger name | Service | What it covers |
|-------------|---------|----------------|
| `graph-query-api.ingest` | graph-query-api | All upload endpoints (graph, telemetry, knowledge, prompts) |
| `graph-query-api.cosmos` | graph-query-api | Cosmos client operations (get_mgmt_client, container creation) |
| `graph-query-api.indexer` | graph-query-api | AI Search index creation and management |
| `graph-query-api.blob` | graph-query-api | Blob storage uploads |
| `app.fabric-provision` | api | Fabric workspace/lakehouse/eventhouse/ontology provisioning |
| `api.config` | api | Agent provisioning (Cosmos prompt fetch, config persistence) |

**Implementation**: Add a new SSE endpoint that filters to data-operation loggers only.

### 2. Divorce log terminals from scenario loading

Move the tabbed log stream out of `MetricsBar` (which is inside the investigation panel, gated on `activeScenario`) and into a persistent bottom panel that renders regardless of application state.

The graph topology viewer stays in `MetricsBar` (scenario-dependent), but the terminals become always-visible infrastructure.

## Design

### Current layout
```
┌─────────────────────────────────────────────┐
│ Header                                      │
├─────────────────────────────────────────────┤
│ TabBar                                      │
├─────────────────────────────────────────────┤
│                                             │
│  (empty state — no terminals visible)       │
│                                             │
│  OR                                         │
│                                             │
│  MetricsBar (graph + 2 terminals)           │  ← only when scenario active
│  Investigation + Diagnosis                  │
│                                             │
└─────────────────────────────────────────────┘
```

### New layout
```
┌─────────────────────────────────────────────┐
│ Header                                      │
├─────────────────────────────────────────────┤
│ TabBar                                      │
├─────────────────────────────────────────────┤
│                                             │
│  Main content area                          │
│  (empty state / investigation / resources)  │
│                                             │
├─────────────────────────────────────────────┤  ← resizable divider
│ ┌─────────┬───────────┬──────────┐          │
│ │ API     │ Graph API │ Data Ops │          │  ← always visible, 3 tabs
│ ├─────────┴───────────┴──────────┤          │
│ │ 14:31:02 INFO app.config: ...  │          │
│ │ 14:31:03 INFO cosmos: upsert.. │          │
│ └────────────────────────────────┘          │
└─────────────────────────────────────────────┘
```

The terminal panel:
- **Always renders** — visible on empty state, during uploads, during investigation
- **Collapsible** — user can drag the divider down to minimize or click a toggle
- **3 tabs**: API, Graph API, Data Ops
- **Starts streaming immediately** on page load (SSE connects on mount, not on scenario select)

## Implementation Plan

### Phase 1 — Backend: Data Ops log endpoint (~20 lines)

**graph-query-api/main.py** — Add a second LogBroadcaster filtered to data-operation loggers:

```python
# Existing: streams ALL graph-query-api.* logs
_log_broadcaster = LogBroadcaster(...)

# New: streams ONLY data-operation logs
_data_ops_broadcaster = LogBroadcaster(max_buffer=200, max_queue=500)
_data_ops_handler = _data_ops_broadcaster.get_handler(level=logging.DEBUG)
_data_ops_handler.setFormatter(...)
_data_ops_handler.addFilter(
    lambda r: r.name.startswith((
        "graph-query-api.ingest",
        "graph-query-api.cosmos",
        "graph-query-api.indexer",
        "graph-query-api.blob",
    ))
)
logging.getLogger().addHandler(_data_ops_handler)

@app.get("/query/logs/data-ops")
async def stream_data_ops_logs():
    return StreamingResponse(
        _data_ops_broadcaster.subscribe(),
        media_type="text/event-stream",
        headers={"Cache-Control": "no-cache", "X-Accel-Buffering": "no"},
    )
```

**api/app/routers/logs.py** — Add a second broadcaster for Fabric + provisioning logs:

⚠️ **GOTCHA — EventSourceResponse double-wraps pre-formatted SSE.** The `LogBroadcaster.subscribe()` generator yields pre-formatted SSE strings (`"event: log\ndata: {...}\n\n"`). `EventSourceResponse` (sse-starlette v2+) treats string yields as data payloads and wraps them in *another* SSE frame, producing `data: event: log\ndata: data: {...}` — garbage that the frontend `EventSource` can't parse.

The existing `/api/logs` endpoint already has this bug but it happens to work because both the inner `event: log` format and sse-starlette's outer wrapping produce parseable output in the current browser EventSource implementation. **However, the event name gets lost** — the frontend listens for `addEventListener('log', ...)`, but sse-starlette rewrites the event type to `message`. This needs investigation.

**Fix: Use `StreamingResponse` (like graph-query-api does), NOT `EventSourceResponse`:**

```python
from starlette.responses import StreamingResponse

_data_ops_broadcaster = LogBroadcaster(max_buffer=200, max_queue=500)
_data_ops_handler = _data_ops_broadcaster.get_handler(level=logging.DEBUG)
_data_ops_handler.addFilter(
    lambda r: r.name.startswith(("app.fabric", "api.config"))
)
logging.getLogger().addHandler(_data_ops_handler)

@router.get("/logs/data-ops")
async def stream_data_ops_logs():
    return StreamingResponse(
        _data_ops_broadcaster.subscribe(),
        media_type="text/event-stream",
        headers={"Cache-Control": "no-cache", "X-Accel-Buffering": "no"},
    )
```

Also audit the existing `/api/logs` endpoint — it uses `EventSourceResponse` but should likely switch to `StreamingResponse` for consistency.

The frontend `LogStream` component already supports arbitrary URLs — just add a third stream definition.

### Phase 2 — Frontend: Persistent terminal panel (~50 lines)

#### 2a. Create `TerminalPanel.tsx`

A new component that wraps `TabbedLogStream` with 3 streams and renders independently of scenario state:

```tsx
const LOG_STREAMS = [
  { url: '/api/logs', title: 'API' },
  { url: '/query/logs', title: 'Graph API' },
  { url: '/api/logs/data-ops', title: 'Data Ops' },
];

export function TerminalPanel() {
  return (
    <div className="h-full">
      <TabbedLogStream streams={LOG_STREAMS} />
    </div>
  );
}
```

#### 2b. Update `App.tsx` layout

⚠️ **GOTCHA — Nested PanelGroup layout.** The current investigation tab already contains a vertical `PanelGroup` (MetricsBar 30% / Investigation 70%). Adding a persistent terminal panel below the main content requires a **new outer PanelGroup** wrapping the content area and terminal. This creates nested vertical PanelGroups — supported by `react-resizable-panels` but the nesting must be explicit:

```
<div className="h-screen flex flex-col">
  <Header />                              // fixed
  <TabBar />                              // fixed
  <PanelGroup orientation="vertical">     // NEW outer — fills flex-1
    <Panel defaultSize={75}>              // main content
      {activeTab === 'investigate' ? (
        !activeScenario ? <EmptyState /> : (
          <PanelGroup orientation="vertical">   // EXISTING inner
            <Panel><MetricsBar /></Panel>        // graph only (no terminals)
            <Panel><Investigation /></Panel>
          </PanelGroup>
        )
      ) : ...}
    </Panel>
    <PanelResizeHandle />                 // NEW — drag to resize terminal
    <Panel defaultSize={25} minSize={8} collapsible>
      <TerminalPanel />                   // always visible
    </Panel>
  </PanelGroup>
</div>
```

Key: the outer PanelGroup replaces the current `<div className="flex-1 min-h-0 flex">` wrapper. The inner PanelGroup (MetricsBar ↔ Investigation) stays as-is but only renders when a scenario is active.

⚠️ **GOTCHA — Collapsible state persistence.** Use `react-resizable-panels`' `onLayout` callback to persist the panel sizes to `localStorage`, so the terminal stays collapsed/resized across page reloads:

```tsx
<PanelGroup
  orientation="vertical"
  onLayout={(sizes) => localStorage.setItem('terminal-layout', JSON.stringify(sizes))}
>
```

#### 2c. Update `MetricsBar.tsx`

Remove the `TabbedLogStream` from MetricsBar. It becomes just the graph topology viewer (which is already scenario-dependent — that's correct, since topology needs data to display).

```tsx
// Before: PanelGroup with graph (64%) + logs (36%)
// After: Just the graph viewer, full width
export function MetricsBar() {
  return (
    <div className="h-full px-6 py-3">
      <GraphTopologyViewer width={...} height={...} />
    </div>
  );
}
```

### Phase 3 — Data Ops stream aggregation (optional enhancement)

The "Data Ops" tab currently has two sources:
- `/api/logs/data-ops` — Fabric provisioning, agent config
- `/query/logs/data-ops` — Cosmos, blob, search, ingest

For a single unified "Data Ops" tab, the `LogStream` component would need to connect to **two** SSE sources and merge them chronologically. Options:

**Option A — Frontend merge** (simple):
Enhance `LogStream` to accept `url: string | string[]`. When array, open multiple `EventSource` connections and merge entries by timestamp.

**Option B — Backend proxy** (cleaner):
Add a single `/api/logs/data-ops` endpoint in the API service that:
1. Broadcasts its own data-ops logs (Fabric, config)
2. Also connects to `http://127.0.0.1:8100/query/logs/data-ops` internally and re-broadcasts those entries

This gives one SSE connection to the frontend. More work but simpler frontend.

**Recommendation**: Option A for v11b — it's 10 lines of frontend change and avoids cross-service HTTP complexity.

⚠️ **GOTCHA — Timestamp merge tiebreaker.** The `ts` field is `HH:MM:SS.mmm` (no date component). Two entries from different services at the same millisecond would have identical timestamps and non-deterministic sort order. Use the module-level `_logIdCounter` (monotonically increasing across all LogStream instances) as the tiebreaker — entries are inserted in arrival order, which is correct enough for interleaved streams.

⚠️ **GOTCHA — Vite dev proxy.** The new `/api/logs/data-ops` URL needs SSE proxy support in `vite.config.ts`. The existing `/api/logs` proxy entry uses prefix matching, so `/api/logs/data-ops` should inherit its SSE config. Verify in local dev — if it doesn't work, add an explicit entry:
```ts
'/api/logs/data-ops': {
  target: 'http://localhost:8000',
  changeOrigin: true,
  configure: (proxy) => {
    proxy.on('proxyRes', (proxyRes) => {
      proxyRes.headers['cache-control'] = 'no-cache';
      proxyRes.headers['x-accel-buffering'] = 'no';
    });
  },
},
```

## Files Changed

| File | Change |
|------|--------|
| `graph-query-api/main.py` | Add `/query/logs/data-ops` endpoint with filtered broadcaster |
| `api/app/routers/logs.py` | Add `/api/logs/data-ops` endpoint with filtered broadcaster |
| `frontend/src/components/TerminalPanel.tsx` | **New** — persistent 3-tab terminal |
| `frontend/src/components/LogStream.tsx` | Support `url: string \| string[]` for multi-source merge |
| `frontend/src/App.tsx` | Add `TerminalPanel` outside scenario gate, wrap in resizable panel |
| `frontend/src/components/MetricsBar.tsx` | Remove `TabbedLogStream`, become graph-only |
| `frontend/src/components/TabbedLogStream.tsx` | Update stream definitions (or delete if inlined into TerminalPanel) |

## Risk

**Low.** All changes are additive — new SSE endpoints, new UI panel. No existing behavior changes. The only visual change is moving terminals from inside the investigation panel to a persistent bottom bar.

**Known edge cases:**
- Empty state gets vertically compressed (~75% of viewport instead of 100%) — acceptable, the upload button stays centered
- Resources tab gains a terminal panel below it — intentional, gives visibility during Fabric operations
- Nested vertical PanelGroups (outer: content/terminal, inner: graph/investigation) — supported by react-resizable-panels, just needs careful default sizes

## Effort

- Phase 1 (backend endpoints): ~30 min
- Phase 2 (frontend layout): ~1 hour  
- Phase 3 (multi-source merge): ~30 min

Total: ~2 hours

## Audit Findings

Issues found during pre-implementation audit against the current codebase:

| # | Issue | Severity | Status |
|---|-------|----------|--------|
| 1 | `EventSourceResponse` double-wraps pre-formatted SSE strings from `LogBroadcaster.subscribe()` — use `StreamingResponse` instead | **HIGH** | Fixed in plan — Phase 1 code samples updated |
| 2 | Multi-source timestamp merge needs tiebreaker (same-millisecond entries from different services) | MEDIUM | Fixed in plan — use `_logIdCounter` |
| 3 | Vite dev proxy may need explicit `/api/logs/data-ops` entry for SSE support | MEDIUM | Noted — verify during implementation |
| 4 | Nested PanelGroup layout needs explicit outer wrapper replacing `flex-1` div | **HIGH** | Fixed in plan — exact nesting structure specified |
| 5 | Empty state vertically compressed by terminal panel | LOW | Accepted — upload button stays centered |
| 6 | Resources tab gains always-visible terminal | LOW | Intentional — provides Fabric ops visibility |
| 7 | Terminal collapse state should persist across reloads | LOW | Fixed in plan — `onLayout` → `localStorage` |
| 8 | Existing `/api/logs` endpoint may have same `EventSourceResponse` wrapping issue | MEDIUM | Noted — audit during implementation |
